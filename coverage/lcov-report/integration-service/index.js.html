<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for integration-service/index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">integration-service/</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">81.54% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>53/65</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>11/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">84.62% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">81.54% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>53/65</span>
      </div>
      <div class='fl pad1y'>
        <span class="strong">2 statements, 1 function, 1 branch</span>
        <span class="quiet">Ignored</span>  &nbsp;&nbsp;&nbsp;&nbsp;
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// We use express for our webserver
var express = require('express')
// body-parser allows us to get an incomming request's JSON body as an object
var bodyParser = require('body-parser')
// We use crypto to generate a random password for our user
var crypto = require('crypto')
// We use the storj client to generate a new user on the bridge
var storj = require('storj')
// We use basic-auth to parse the Authentication header on incomming requests
var auth = require('basic-auth')
// Load in the db to keep track of registered users and their plan tiers
var db = require('./db.js')
// Load in our runtime config as a read-only object
var config = require('./config')
// node-uuid allows us to generate a UUID for each request, so we can use it
// when logging to help with tracing
var uuid = require('node-uuid')
&nbsp;
// Begin building our http server
var app = express()
// Parse all incomming requests as having a JSON body (gives us an object to
// work with on req.body)
app.use(bodyParser.json())
&nbsp;
// Create a new client to communicate with the storj bridge
var storjClient = storj.BridgeClient(config.storj.api)
&nbsp;
// Ensure all incomming requests are given a UUID for this service to help
// us identify logs
app.use('*', function addUUID(req, res, next) {
  req.uuid = uuid.v4()
  next()
})
&nbsp;
// Health check
app.get('/health', <span class="fstat-no" title="function not covered" >function(req, res) {</span>
<span class="cstat-no" title="statement not covered" >  return res.status(200).end()</span>
})
//
// Health check Kubernetes
app.get('/', <span class="fstat-no" title="function not covered" >function(req, res) {</span>
<span class="cstat-no" title="statement not covered" >  return res.status(200).end()</span>
})
&nbsp;
// Ensure incomming requests are authenticated using our heroku shared secrets
app.use('/heroku', function enforceAuth(req, res, next) {
  var creds = auth(req);
&nbsp;
  <span class="missing-if-branch" title="if path not taken" >I</span>if ( typeof creds === 'undefined' ) {
<span class="cstat-no" title="statement not covered" >    console.error(`${req.uuid}: Incoming request provided no auth data`);</span>
<span class="cstat-no" title="statement not covered" >    return res.status(401).end();</span>
  }
&nbsp;
  if ( creds.pass !== config.heroku.password ||
       creds.name !== config.heroku.id ) {
    // If either the id or password don't match, reject the request
    console.error(`${req.uuid}: Incomming request failed authentication`)
    console.error(`${req.uuid}: ID: "${creds.name}" Password: "${creds.pass}"`)
    return res.status(401).end()
  }
  // If we pass authentication, let the next handler take over
  next()
})
&nbsp;
/*
 * POST /horoku/resources
 *
 * Create a new storj resource for a customer
 */
app.post('/heroku/resources', function provisionRequest(req, res) {
  // We generate the user's email address for this add-on by using the UUID
  // of the heroku add-on at our own email service. This allows the bridge to
  // send an email to this user in it's normal fashion, that email will be
  // intercepted by another one of our services and forwarded onto the user's
  // real email address
  var email = `${req.body.uuid}@heroku.storj.io`
  // Generate a random password for our user
  var password = crypto.randomBytes(48).toString('base64')
  console.log(`${req.uuid}: Creating user: "${email}"`)
  // Create a new account on the bridge using the email address and password
  // generated above
  storjClient.createUser({
    email: email,
    password: password
  }, function(e) {
    // If we fail to create the user on the bridge, return a message asking the
    // user to try again later, and give heroku a 503.
    <span class="missing-if-branch" title="if path not taken" >I</span>if (e) {
<span class="cstat-no" title="statement not covered" >      console.log(`${req.uuid}: "${e.message}"`)</span>
<span class="cstat-no" title="statement not covered" >      return res.status(503).json({</span>
        'message': `${req.uuid}: Unable to create user on bridge, please try again later`
      })
    }
&nbsp;
    console.log(`${req.uuid}: Adding "${email}" to DB`)
    var document = {
      // All add-on are identified by their heroku UUID, so we will use that
      // as the index key
      id: req.body.uuid,
      // Assign the user to the plan tier they requested
      tier: req.body.plan,
      // The active key reflects if this add-on is still live on heroku. Since
      // we don't store the user's password, we are unable to delete the user
      // from the bridge directly. Instead, we toggle this value to false
      // indicating that we no longer are billing this customer for resources.
      // Later on, we may feed a report from our DB into the bridge to disable
      // all accounts that have been deactiavted on heroku.
      active: true
    }
&nbsp;
    // Insert our new user into the database
    db.insert(document, function insertedIntoMongo (e) {
      // If we fail to add the user to the database, give heroku a 503 and tell
      // the user what happened
      <span class="missing-if-branch" title="if path not taken" >I</span>if(e) {
<span class="cstat-no" title="statement not covered" >        console.error(`${req.uuid}: ${e.message}`)</span>
<span class="cstat-no" title="statement not covered" >        return res.status(503).json({</span>
          'message': `${req.uuid}: Unable to create user in Database, please try again later`
        })
      }
&nbsp;
      // Let heroku know that this was a success
      return res.json({
        // Since we are using heroku's UUID for our index key when creating
        // plans, we can go ahead and send that back to heroku for future
        // reference
        'id': req.body.uuid,
        // The email and password will be provided to the user's dynos as
        // the environment variables below
        'config': {
          'STORJ_EMAIL': email,
          'STORJ_PASSWORD': password
        }
      })
    })
  })
})
&nbsp;
/*
 * PUT /heroku/resources/[id]
 *
 * Change the plan tier of a user's add-on
 */
app.put('/heroku/resources/:id', function(req, res) {
  // Heroku give's us the UUID of the integration, which we are using as a key
  // in the database
  var key = {
    id: req.params.id
  }
&nbsp;
  // Define the updates we would like to make to the values for this entry in
  // the database. In this case, we are changing the plan tier to the new
  // value provided by heroku
  var document = {
    tier: req.body.plan
  }
&nbsp;
  // Go ahead and commit the changes defined above to the database
  db.update(key, document, function(e) {
    // If we failed to commit the change to the database, let heroku know it
    // failed so they can retry later
    <span class="missing-if-branch" title="if path not taken" >I</span>if (e) {
<span class="cstat-no" title="statement not covered" >      console.error(`${req.uuid}: ${e.message}`)</span>
<span class="cstat-no" title="statement not covered" >      return res.status(503).json({</span>
        'message': `${req.uuid}: Unable to update plan in database, please try again later`
      })
    }
&nbsp;
    // Let heroku know the plan was changed successfully
    return res.json({
      'message': 'Success!'
    })
  })
})
&nbsp;
/*
 * DELETE /heroku/resources[id]
 *
 * Deactivate a user's add-on
 */
app.delete('/heroku/resources/:id', function(req, res) {
  // Heroku give's us the UUID of the integration, which we are using as a key
  // in the database
  var key = {
    id: req.params.id
  }
&nbsp;
  // Deactivate the key in the database
  db.delete(key, function(e) {
    // If we failed to commit the change to the database, let heroku know it
    // failed so they can retry later
    <span class="missing-if-branch" title="if path not taken" >I</span>if (e) {
<span class="cstat-no" title="statement not covered" >      console.log(`${req.uuid}: ${e.message}`)</span>
<span class="cstat-no" title="statement not covered" >      return res.status(503).json({</span>
        'message': `${req.uuid}: Unable to delete plan in database, please try again later`
      })
    }
&nbsp;
    // Let heroku know the plan was deactivated
    return res.json({
      'message': 'Success!'
    })
  })
})
&nbsp;
// Make this easier to test. If we are required in by another module, we will
// export a function that lets that module control this application.
/* istanbul ignore else */
<span class="skip-if-branch" title="else path not taken" >E</span>if(module.parent) {
  // Allow the module requiring us in to define a port they want us to listen
  // on, and return the server instance created by .listen so that the module
  // can shut us down
  module.exports = function listen(port) {
    var server = app.listen(port)
    // When the module requiring us in closes our connection, shut down our
    // connection to the database as well
    server.on('close', db.close)
    return server
  }
} else {
  // If we are started directly from the command line, go ahead and run the
  // server on port 8080
<span class="cstat-skip" title="statement not covered" >  app.listen(8080, <span class="fstat-skip" title="function not covered" >function() {</span></span>
<span class="cstat-skip" title="statement not covered" >    console.log('Listening on port: 8080')</span>
  })
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Sep 14 2016 10:48:14 GMT-0400 (EDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
